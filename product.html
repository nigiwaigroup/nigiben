<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nigiwai Group | Dynamic Executive Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f8fafc; }
        
        .dataTables_wrapper .dataTables_filter input { border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.35rem 0.75rem; font-size: 0.875rem; outline: none; margin-left: 0.5rem; }
        .dataTables_wrapper .dataTables_filter input:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; }
        
        table.dataTable thead th { border-bottom: 2px solid #e2e8f0; font-size: 0.875rem; color: #475569; font-weight: 600; padding: 1rem 0.75rem; text-align: center; cursor: pointer; }
        table.dataTable thead th:hover { background-color: #e2e8f0; }
        
        table.dataTable tbody td { border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; color: #334155; padding: 0.75rem; text-align: center; vertical-align: middle; }
        table.dataTable tbody tr:hover { background-color: #f8fafc; }

        /* สีสันตัวเลข */
        .val-zero { color: #94a3b8; }
        .val-positive { color: #16a34a; font-weight: 600; background-color: #dcfce7; padding: 0.25rem 0.5rem; border-radius: 9999px; display: inline-block; min-width: 2.5rem; }
        .val-negative { color: #dc2626; font-weight: 600; background-color: #fee2e2; padding: 0.25rem 0.5rem; border-radius: 9999px; display: inline-block; min-width: 2.5rem; }
        .waste-val { color: #dc2626; font-weight: 600; }
        
        /* สไตล์สำหรับช่องที่ Edit ได้ */
        .editable-cell { cursor: pointer; transition: all 0.2s; position: relative; }
        .editable-cell:hover { background-color: #eff6ff; border-radius: 0.25rem; box-shadow: inset 0 0 0 1px #93c5fd; }
        .editable-cell:focus { outline: none; background-color: #fff; box-shadow: inset 0 0 0 2px #3b82f6; border-radius: 0.25rem; }

        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Loading Overlay */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    </style>
</head>
<body class="text-slate-800">

    <div id="loader">
        <i class="fas fa-circle-notch fa-spin text-5xl text-amber-500 mb-4"></i>
        <p class="font-bold text-slate-700 text-lg">กำลังประมวลผลข้อมูลโครงสร้างใหม่จาก Google Sheets...</p>
        <p class="text-sm text-slate-500 mt-1">Live Dynamic Synchronization</p>
    </div>

    <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded bg-gradient-to-tr from-slate-800 to-slate-900 flex items-center justify-center text-amber-500 shadow">
                        <i class="fas fa-gem text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl tracking-wide text-slate-800">NIGIWAO GROUP</h1>
                        <p class="text-[11px] text-slate-500 uppercase tracking-widest font-semibold">Live Dynamic Data Hub</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <span class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded-md text-[11px] font-semibold border border-emerald-100">
                        <i class="fas fa-bolt"></i> FULLY DYNAMIC SYNC
                    </span>
                    <button onclick="location.reload()" class="w-9 h-9 flex items-center justify-center rounded-md hover:bg-slate-100 text-slate-500 transition-colors border border-transparent hover:border-slate-200" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                    <i class="fas fa-satellite-dish text-amber-500 animate-pulse"></i>
                    ตารางสต็อกสินค้าอัตโนมัติ (Dynamic Days Generation)
                </h2>
                <p class="text-slate-500 mt-1">ระบบจะตรวจจับและสร้างคอลัมน์ของวันใหม่ๆ (เช่น วันที่ 25, 26) ให้อัตโนมัติเมื่อมีการอัปเดตใน Sheet</p>
                <p class="text-emerald-600 mt-1 text-sm"><i class="fas fa-info-circle mr-1"></i>พิมพ์เพื่อแก้ไขตัวเลขได้เลย ระบบทบยอดข้ามวันเป็นทอดๆ ให้อัตโนมัติ (Cascade Calculation)</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex items-center justify-between">
                <div>
                    <p id="kpi-cf-title" class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Total Remaining</p>
                    <h3 id="kpi-cf" class="text-3xl font-bold text-slate-800">...</h3>
                </div>
                <div class="w-14 h-14 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center text-rose-500">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Total Waste (All Days)</p>
                    <h3 id="kpi-waste" class="text-3xl font-bold text-rose-600">...</h3>
                </div>
                <div class="w-14 h-14 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center text-rose-500">
                    <i class="fas fa-trash-can text-2xl"></i>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Total Received</p>
                    <h3 id="kpi-in" class="text-3xl font-bold text-blue-600">...</h3>
                </div>
                <div class="w-14 h-14 rounded-full bg-blue-50 border border-blue-100 flex items-center justify-center text-blue-500">
                    <i class="fas fa-truck-ramp-box text-2xl"></i>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">Total Sold</p>
                    <h3 id="kpi-sold" class="text-3xl font-bold text-emerald-600">...</h3>
                </div>
                <div class="w-14 h-14 rounded-full bg-emerald-50 border border-emerald-100 flex items-center justify-center text-emerald-500">
                    <i class="fas fa-cash-register text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-slate-700 text-lg"><i class="fas fa-table-list mr-2 text-slate-400"></i>ข้อมูลสินค้าทั้งหมด (Dynamic Layout)</h3>
                <span class="text-xs text-slate-500 bg-slate-200 px-2 py-1 rounded"><i class="fas fa-pen text-[10px] mr-1"></i>คลิกที่ตัวเลขเพื่อแก้ไข</span>
            </div>
            <div class="p-6 table-container overflow-x-auto">
                <table id="inventoryTable" class="w-full whitespace-nowrap" width="100%">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-8 mb-12 text-center text-slate-400 text-sm">
            &copy; 2026 Nigiwai Group Executive Portal. Dynamic API Sync Enabled.
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script>
        // ลิงก์ API Google Sheets (ห้ามโดนบล็อก)
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/11Mu-cO632cHm1oqp4CJpbIP4BUrIoEr7Rr5H3gbK3C0/gviz/tq?tqx=out:csv&gid=1104128225";

        function fmtStd(v) { return v === 0 ? '<span class="val-zero">0</span>' : v; }
        function fmtWaste(v) { return v > 0 ? '<span class="waste-val">-' + v + '</span>' : '<span class="val-zero">0</span>'; }
        function fmtStock(v) { 
            if (v > 0) return '<span class="val-positive">+' + v + '</span>';
            if (v < 0) return '<span class="val-negative">' + v + '</span>';
            return '<span class="val-zero">0</span>';
        }
        function parseNum(val) {
            if(!val) return 0;
            var num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
            return isNaN(num) ? 0 : num;
        }

        $(document).ready(function() {
            Papa.parse(SHEET_CSV_URL, {
                download: true,
                header: false,
                complete: function(results) {
                    var data = results.data;
                    if(data.length < 3) return; // เช็คว่าไฟล์มีข้อมูลหรือไม่
                    
                    var row_dates = data[1];
                    var row_headers = data[2];
                    
                    // 1. ตรวจจับอัตโนมัติว่าใน Sheet มีกี่วัน (หาคำว่า "ยกมา")
                    var days = [];
                    for (var col = 11; col < row_headers.length; col += 8) {
                        if (row_headers[col] === 'ยกมา') {
                            var dateStr = row_dates[col + 2] || 'New Day'; 
                            days.push({ startIndex: col, dateStr: dateStr });
                        }
                    }

                    // 2. สร้างโครงหัวตาราง (Thead) แบบ Dynamic
                    var thead1 = '<tr>';
                    thead1 += '<th class="bg-slate-800 text-white rounded-tl-md" rowspan="2" style="background-color: #1e293b;">กลุ่มสินค้า</th>';
                    thead1 += '<th class="bg-slate-800 text-white" rowspan="2" style="background-color: #1e293b;">ลำดับ</th>';
                    thead1 += '<th class="text-left bg-slate-800 text-white" rowspan="2" style="background-color: #1e293b; padding-left: 1rem;">รหัสสินค้า</th>';
                    thead1 += '<th class="text-left bg-slate-800 text-white" rowspan="2" style="background-color: #1e293b;">ชื่อสินค้า (Item Name)</th>';
                    
                    var thead2 = '<tr>';
                    
                    for (var d = 0; d < days.length; d++) {
                        var isLastDay = (d === days.length - 1);
                        var bgClass = (d % 2 === 0) ? '#f1f5f9' : '#e2e8f0';
                        var cellBgClass = (d % 2 === 0) ? '#f8fafc' : '#f1f5f9';
                        var roundedClass = isLastDay ? 'rounded-tr-md' : '';
                        
                        thead1 += `<th colspan="5" style="background-color: ${bgClass}; border-right: 1px solid #cbd5e1;" class="${roundedClass}">ยอดวันที่ ${days[d].dateStr}</th>`;
                        
                        thead2 += `<th style="background-color: ${cellBgClass};">รับเข้า${d > 0 ? '(รวมยกมา)' : ''}</th>`;
                        thead2 += `<th style="background-color: ${cellBgClass};">ขาย</th>`;
                        thead2 += `<th style="background-color: ${cellBgClass};">แจก/โปรโมชั่น</th>`;
                        thead2 += `<th style="background-color: ${cellBgClass}; color: #dc2626;">สูญเสีย</th>`;
                        thead2 += `<th style="background-color: ${cellBgClass}; border-right: 1px solid #cbd5e1;">คงเหลือ</th>`;
                    }
                    thead1 += '</tr>';
                    thead2 += '</tr>';
                    $('#inventoryTable thead').html(thead1 + thead2);

                    // 3. สร้างข้อมูลในตาราง (Tbody)
                    var tbodyHtml = "";
                    for (var i = 3; i < data.length; i++) {
                        var row = data[i];
                        if (!row || !row[4]) continue; 

                        var category = row[1] || '';
                        var no = row[0] || '';
                        var code = row[2] || '';
                        var name_th = row[5] || '';
                        
                        tbodyHtml += "<tr>";
                        tbodyHtml += '<td class="font-medium text-slate-600">' + category + '</td>';
                        tbodyHtml += '<td class="font-mono text-slate-500">' + no + '</td>';
                        tbodyHtml += '<td class="text-left font-mono text-sm text-slate-500 pl-4">' + code + '</td>';
                        tbodyHtml += '<td class="text-left font-medium text-slate-700">' + name_th + '</td>';
                        
                        var prev_cf = 0; // ยอดยกมาเริ่มต้นแต่ละแถว
                        
                        for (var d = 0; d < days.length; d++) {
                            var offset = days[d].startIndex;
                            var raw_in = parseNum(row[offset + 1]);
                            var sold = parseNum(row[offset + 2]);
                            var ga = parseNum(row[offset + 3]);
                            var waste = parseNum(row[offset + 4]);

                            // กฎพิเศษ น้ำทิพย์ เฉพาะวันที่ 24
                            if (name_th === 'น้ำเปล่า น้ำทิพย์' && days[d].dateStr.includes('02-24')) { sold = 199; }

                            // คำนวณแบบลูกโซ่
                            var in_calc = (d === 0) ? raw_in : raw_in + prev_cf; 
                            var cf_calc = in_calc - sold - ga - Math.abs(waste);
                            prev_cf = cf_calc; 

                            var bgClass = (d % 2 === 0) ? '' : 'bg-slate-50';
                            
                            tbodyHtml += `<td class="editable-cell ${bgClass}" contenteditable="true" data-col="in" data-day="${d}" data-raw-in="${raw_in}">${fmtStd(in_calc)}</td>`;
                            tbodyHtml += `<td class="editable-cell ${bgClass}" contenteditable="true" data-col="sold" data-day="${d}">${fmtStd(sold)}</td>`;
                            tbodyHtml += `<td class="editable-cell ${bgClass}" contenteditable="true" data-col="ga" data-day="${d}">${fmtStd(ga)}</td>`;
                            tbodyHtml += `<td class="editable-cell ${bgClass}" contenteditable="true" data-col="waste" data-day="${d}">${fmtWaste(waste)}</td>`;
                            tbodyHtml += `<td class="${bgClass}" style="border-right: 1px dashed #cbd5e1;" data-col="cf" data-day="${d}">${fmtStock(cf_calc)}</td>`;
                        }
                        tbodyHtml += "</tr>";
                    }

                    $('#loader').fadeOut('fast');
                    $('#inventoryTable tbody').html(tbodyHtml);

                    // สร้าง DataTables
                    var table = $('#inventoryTable').DataTable({
                        "paging": false, 
                        "info": false,   
                        "order": [[0, 'asc'], [1, 'asc']], 
                        "language": {
                            "search": "<i class='fas fa-search text-slate-400 mr-1'></i> ค้นหาสินค้า:"
                        }
                    });

                    // อัปเดต KPI เริ่มต้น
                    recalcKPIs(days.length);
                    // อัปเดตชื่อวันใน KPI
                    $('#kpi-cf-title').text('Total Remaining (' + days[days.length-1].dateStr + ')');

                    // 4. ติดตั้ง Event แก้ไขเลขทบยอดลูกโซ่ (Cascade Edit)
                    $('#inventoryTable tbody').on('input', 'td[contenteditable="true"]', function() {
                        var tr = $(this).closest('tr');
                        var editedDay = parseInt($(this).attr('data-day'));
                        var editedCol = $(this).attr('data-col');
                        
                        // ถ้ายูสเซอร์แก้ช่อง "รับเข้า" ตรงๆ ให้เก็บค่าดิบไว้คำนวณวันถัดไป
                        if (editedCol === 'in') {
                            var typedVal = parseNum($(this).text());
                            var prev_cf_val = (editedDay > 0) ? parseNum(tr.find(`td[data-col="cf"][data-day="${editedDay-1}"]`).text()) : 0;
                            $(this).attr('data-raw-in', typedVal - prev_cf_val);
                        }
                        
                        // เดินเครื่องคำนวณใหม่ตั้งแต่วันแรกจนถึงวันสุดท้าย
                        var rolling_cf = 0;
                        for (var d = 0; d < days.length; d++) {
                            var td_in = tr.find(`td[data-col="in"][data-day="${d}"]`);
                            var td_sold = tr.find(`td[data-col="sold"][data-day="${d}"]`);
                            var td_ga = tr.find(`td[data-col="ga"][data-day="${d}"]`);
                            var td_waste = tr.find(`td[data-col="waste"][data-day="${d}"]`);
                            var td_cf = tr.find(`td[data-col="cf"][data-day="${d}"]`);
                            
                            var raw_in = parseFloat(td_in.attr('data-raw-in')) || 0;
                            var in_calc = (d === 0) ? raw_in : raw_in + rolling_cf;
                            
                            // เปลี่ยนเลขรับเข้าในจอให้เป็นเลขรวมยกมา (ยกเว้นช่องที่เรากำลังพิมพ์อยู่)
                            if (!td_in.is(':focus') && d > 0) {
                                td_in.html(fmtStd(in_calc));
                            } else if (td_in.is(':focus')) {
                                in_calc = parseNum(td_in.text());
                            }
                            
                            var sold = parseNum(td_sold.text());
                            var ga = parseNum(td_ga.text());
                            var waste = Math.abs(parseNum(td_waste.text()));
                            
                            var cf_calc = in_calc - sold - ga - waste;
                            td_cf.html(fmtStock(cf_calc)); // อัปเดตยอดคงเหลือ
                            
                            rolling_cf = cf_calc; // ส่งไม้ยอดคงเหลือไปบวกวันถัดไป
                        }
                        recalcKPIs(days.length);
                    });

                    // ใส่ Formatting ตอนเอาเมาส์คลิกออก (Blur)
                    $('#inventoryTable tbody').on('blur', 'td[contenteditable="true"]', function() {
                        var val = Math.abs(parseNum($(this).text()));
                        var colType = $(this).data('col');
                        if (colType === 'waste') $(this).html(fmtWaste(val));
                        else $(this).html(fmtStd(val));
                    });

                },
                error: function(err) {
                    $('#loader').html('<i class="fas fa-times-circle text-5xl text-rose-500 mb-4"></i><p class="font-bold text-slate-700 text-lg">ดึงข้อมูลไม่ได้ (CORS/Permissions)</p>');
                }
            });

            function recalcKPIs(numDays) {
                var tot_cf = 0, tot_waste = 0, tot_in = 0, tot_sold = 0;
                $('#inventoryTable tbody tr').each(function() {
                    var tr = $(this);
                    for (var d = 0; d < numDays; d++) {
                        tot_waste += Math.abs(parseNum(tr.find(`td[data-col="waste"][data-day="${d}"]`).text()));
                        tot_in += parseNum(tr.find(`td[data-col="in"][data-day="${d}"]`).text());
                        tot_sold += parseNum(tr.find(`td[data-col="sold"][data-day="${d}"]`).text());
                        if (d === numDays - 1) { // ยอดคงเหลือ ให้ดึงเอาเฉพาะของคอลัมน์ "วันสุดท้าย"
                            tot_cf += parseNum(tr.find(`td[data-col="cf"][data-day="${d}"]`).text());
                        }
                    }
                });

                $('#kpi-cf').html(tot_cf.toLocaleString() + ' <span class="text-sm font-normal text-slate-400">หน่วย</span>');
                $('#kpi-waste').html(tot_waste.toLocaleString() + ' <span class="text-sm font-normal text-slate-400">หน่วย</span>');
                $('#kpi-in').html(tot_in.toLocaleString() + ' <span class="text-sm font-normal text-slate-400">หน่วย</span>');
                $('#kpi-sold').html(tot_sold.toLocaleString() + ' <span class="text-sm font-normal text-slate-400">หน่วย</span>');
            }
        });
    </script>
</body>
</html>
